---
title: "LFT report Cov-111"
author: "Biometrics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
runtime: shiny
output: 
  html_document:
          css: style.css
---

```{r logo, echo=FALSE, out.width="100px"}
htmltools::img(src = knitr::image_uri(file.path("logo.png")),
               alt = 'logo',
               style = 'position:absolute; top:0; right:0; padding:10px;',
               width='400px')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(openxlsx)
library(rio)
library(lubridate)
library(patchwork)
library(reactable)
library(reactablefmtr)
library(plotly)
library(DT)
library(data.table)
library(shiny)
library(shinyjs)
library(shinyalert)
library(shinyWidgets)

# getwd()

source("global.R")


PPD_LTF <- import("data/Preclarus_Results_BMFS0002 LFTs 22Nov2022.xlsx") 

PPD_LTF_long <- PPD_LTF |>    
  select(-`Rand ID`) |>
  pivot_longer(`SAD Cohorts 1-4: Screening (D -28 to -2)`:`Unscheduled [2]`,
               names_to = "Visit",
               values_to = "Result") |>
  filter(!is.na(Result)) # |>

cohort <- import("data/eCOS_RandList_22-NOV-22_19_06_32.xlsx", skip=4) |>
  filter(!is.na(`Subject ID Assigned`)) |>
  filter(`Randomization Number` != "12010") |>
  select(`Subject ID Assigned`, `Strata Group`, `Randomization Assignment`) |>
  mutate(`Strata Group` = ifelse(`Strata Group` == "SAD2R","SAD2",`Strata Group`))

HV_SubjectID <- cohort |> 
  filter(!(`Strata Group` == "MAD2"))

# subset PPD data to Healthy volunteers
PPD_LTF_long_HV <- PPD_LTF_long |>
  right_join(HV_SubjectID, by=c("Screen ID"="Subject ID Assigned")) |>
  mutate(test = (str_detect(Visit,str_sub(`Strata Group`,1,3)) | str_detect(Visit, "Unsch"))) |> # one subject screened for 2 cohorts, enrolled in 1
  filter(test)


Visits <- PPD_LTF_long_HV |>
  select(Visit) |>
  group_by(Visit) |>
  summarise(n())


PPD_LTF_long_HV <- PPD_LTF_long_HV |>
  mutate(
    `Visit label` = case_when(
      str_detect(Visit ,"Screening") ~ "Screen",
      str_detect(Visit ,"Day 1") ~ "Day 1",
      str_detect(Visit ,"Day 2") ~ "Day 2",
      str_detect(Visit ,"Day 3") ~ "Day 3",
      str_detect(Visit ,"Day 4") ~ "Day 4",
      str_detect(Visit ,"Day 5") ~ "Day 5",
      str_detect(Visit ,"Day 6") ~ "Day 6",
      str_detect(Visit ,"Wk 1") ~ "Day 7",
      str_detect(Visit ,"Wk 2") ~ "Day 14",      
      str_detect(Visit ,"Wk 4") ~ "Day 28",
      str_detect(Visit ,"Unsched") ~ "Unsch"
    )
  ) |>
  mutate(`Visit label` = factor(`Visit label`,
                                levels = c("Screen", "Day 1", "Day 2", "Day 3", "Day 4", "Day 5",
                                           "Day 6", "Day 7", "Day 14", "Day 28", "Unsch")),
         Result = as.numeric(Result),
         LLN = as.numeric(str_sub(Range,
                                  1,
                                  str_locate(Range,"-")[,1]-1)
         ),
         ULN = as.numeric(str_sub(Range,
                                  str_locate(Range,"-")[,1]+1,
                                  str_locate(Range,"-")[,1]+4)
         )
  )

baseline <- PPD_LTF_long_HV |>
  filter(`Visit label` == "Screen") |>
  select(`Screen ID`, `Test Name`, Result) |>
  rename(Baseline = Result) #|>
  # group_by(`Screen ID`) |>
  # summarise(n())
  
PPD_LTF_long_HV_wBase <- PPD_LTF_long_HV |>
  left_join(baseline, by=c("Screen ID", "Test Name")) |>
  mutate(`Fold change from ULN` = Result/ULN,
         `lg Fold change from baseline` = log(Result/Baseline))
  

lft_labs <- PPD_LTF_long_HV |>
  select(`Test Name`) |>
  unique() |>
  unlist()

cohort_grp <- PPD_LTF_long_HV |>
  select(`Strata Group`) |>
  unique() |>
  unlist()

lft_labs1 <- PPD_LTF_long_HV |>
  select(`Test Name`) |>
  unique() 

cohort_grp1 <- PPD_LTF_long_HV |>
  select(`Strata Group`) |>
  unique()

subj1 <- PPD_LTF_long_HV |>
  select(`Strata Group`,`Screen ID`) |>
  unique()
  
```

```{r dimension, echo=FALSE, warning=FALSE}

 knitr::opts_chunk$set(fig.dim = c(12,8))

```

# Healty Volunteers Lab Data review {.tabset .tabset-fade .tabset-pills}

## Alanine Aminotransferase (ALT)

### Figure for Alanine Aminotransferase (ALT){.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r alt_plots1, echo=FALSE, warning=FALSE, results='asis'}

l=1
 alt <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p1=list()

for(i in cohort_grp){
# i="SAD1"
   temp2 <- alt |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p1[[i]] <-
  get_cohort_plot(temp2)

cat('\n')

}

j = 1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p1[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p1[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p1[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p1[[cohort_grp[[j]]]])

cat('\n')

```

## Alkaline Phosphatase

### Figure for Alkaline Phosphatase {.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r alp_plot, echo=FALSE, warning=FALSE, results='asis'}

l=2
 alp <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p2=list()

for(i in cohort_grp){

   temp2 <- alp |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p2[[i]] <- get_cohort_plot(temp2)

cat('\n')

}

j=1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p2[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p2[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p2[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p2[[cohort_grp[[j]]]])


cat('\n')

```

## Amylase

### Figure for Amylase {.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r amyl_plot, echo=FALSE, warning=FALSE, results='asis'}

l=3
 amyl <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p3=list()

for(i in cohort_grp){

   temp2 <- amyl |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p3[[i]] <- get_cohort_plot(temp2)

cat('\n')

}

j=1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p3[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p3[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p3[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p3[[cohort_grp[[j]]]])


cat('\n')

```

## Aspartate Aminotransferase (AST)

### Figure for Aspartate Aminotransferase (AST) {.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r ast_plot, echo=FALSE, warning=FALSE, results='asis'}

l=4
 ast <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p4=list()

for(i in cohort_grp){

   temp2 <- ast |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p4[[i]] <- get_cohort_plot(temp2)

cat('\n')

}

j=1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p4[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p4[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p4[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p4[[cohort_grp[[j]]]])

cat('\n')

```

## Gamma Glutamyl Transferase

### Figure for Gamma Glutamyl Transferase {.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r ggt_plot, echo=FALSE, warning=FALSE, results='asis'}

l=5
 ggt <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p5=list()

for(i in cohort_grp){

   temp2 <- ggt |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p5[[i]] <- get_cohort_plot(temp2)

cat('\n')

}

j=1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p5[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p5[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p5[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p5[[cohort_grp[[j]]]])

cat('\n')

```

## Lipase

### Figure for Lipase {.tabset .tabset-fade .tabset-pills}

*Cov-111, all subjects.*</br>Dashed line are lower and upper limits of normal </br> Click on Autoscale or Home Icon to Reset Selection

```{r lps_plot, echo=FALSE, warning=FALSE, results='asis'}

l=6
 lps <- PPD_LTF_long_HV_wBase |>
    filter(`Test Name` == lft_labs[l])
p6=list()

for(i in cohort_grp){

   temp2 <- lps |> filter(`Strata Group` == i) |> select(`Strata Group`, `Screen ID`, `Visit label`, Result, Unit, Baseline, LLN, ULN, `Fold change from ULN`)

p6[[i]] <- get_cohort_plot(temp2)

cat('\n')

}

j=1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p6[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p6[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p6[[cohort_grp[[j]]]])

j=j+1
cat(paste0("\n\n#### ", cohort_grp[[j]], "\n"))
htmltools::tagList(p6[[cohort_grp[[j]]]])

cat('\n')

```

# 

```{r revsec, echo=FALSE, warning=FALSE}



shinyUI(fluidPage(uiOutput("review"),
                  useShinyalert(),
                  actionButton(inputId = "Updated_review",label = "Save"),
                  helpText("Note: Remember to save any updates!"),hr()))





# note1 <- data.frame(Date=as.character(Sys.Date()),
#                     Test="Alanine Aminotransferase (ALT)",
#                     Strata="SAD1",
#                     Subject="111-101-001",
#                     Comments="Enter your Comments")
# saveRDS(note1,file="note1.rds")



vals_review<- shiny::reactiveValues()
  vals_review$Data<-readRDS("note1.rds")

output$review <- renderUI({
    fluidPage(
      hr(),column(3,HTML('<f2><b> Review Comments</b> </f2>')),
      column(6,offset = 4,
             HTML('<div class="btn-group" role="group" aria-label="Basic example" style = "padding:10px">'),
             ### tags$head() This is to change the color of "Add a new row" button
             tags$head(tags$style(".butt2{background-color:#231651;} .butt2{color: #e6ebef;}")),
             div(style="display:inline-block;width:30%;text-align: center;",actionButton(inputId = "Add_row_head",label = "Add", class="butt2") ),
             tags$head(tags$style(".butt4{background-color:#4d1566;} .butt4{color: #e6ebef;}")),
             div(style="display:inline-block;width:30%;text-align: center;",actionButton(inputId = "mod_row_head",label = "Edit", class="butt4") ),
             tags$head(tags$style(".butt3{background-color:#590b25;} .butt3{color: #e6ebef;}")),
             div(style="display:inline-block;width:30%;text-align: center;",actionButton(inputId = "Del_row_head",label = "Delete", class="butt3") ),
             ### Optional: a html button
             # HTML('<input type="submit" name="Add_row_head" value="Add">'),
             HTML('</div>') ),

      column(12,dataTableOutput("Review_List")),
      tags$script("$(document).on('click', '#Main_table_trich button', function () {
                    Shiny.onInputChange('lastClickId',this.id);
                    Shiny.onInputChange('lastClick', Math.random()) });")

    )

})





output$Review_List<-renderDataTable({
  DT=vals_review$Data
  datatable(DT,selection = 'single',
            escape=F)
})

chs <- reactive(subj1)

observeEvent(input$Add_row_head,{
    ### This is the pop up board for input a new row
   showModal( modalDialog(title = "Add a new row",
                         
                        dateInput(paste0("Date_add", input$Add_row_head), "Date", value=Sys.Date()),
                        shinyWidgets::pickerInput(paste0("Test_add", input$Add_row_head), "Test",
                                      choices=lft_labs1[[1]]),
                       shinyWidgets::radioGroupButtons(paste0("Strata_add",input$Add_row_head),"Strata",
                                     choices=cohort_grp1[[1]]),
                       actionButton(inputId = "Add_sub",label =  "Update Subject List"),
                          shinyWidgets::pickerInput(paste0("Subject_add", input$Add_row_head), "Subject",
                       choices= ""),
                      
                         textAreaInput(paste0("Comments_add", input$Add_row_head), "Comments"),
                          actionButton(inputId = "go",label =  "Add Review"),
                         
                          easyClose = TRUE , footer = NULL ))

  })

observeEvent(input$Add_sub,{
    ### This is the pop up board for input a new row
   shinyWidgets::updatePickerInput(session=session,paste0("Subject_add", input$Add_row_head), "Subject",
                       choices= filter(subj1,`Strata Group`==input[[paste0("Strata_add",input$Add_row_head)]])[[2]])


  })


# cohsub <- reactive({filter(subj1, `Strata Group`==input[[paste0("Strata_add",input$Add_row_head)]])})
# 
# observeEvent(input$t1,{
#   print("hello")
#   shinyWidgets::updatePickerInput(session=session,inputId = paste0("Subject_add", input$Add_row_head),"Strata",
#                     choices = filter(subj1,`Strata Group`== input[[paste0("Strata_add", input$Add_row_head)]])[[2]])
# })
# observeEvent(input$paste0("Strata_add",input$Add_row_head),{
#   shinyWidgets::updatePickerInput(inputId = paste0("Subject_add", input$Add_row_head),
#                     choices = C(filter(subj1,`Strata Group`== input[[paste0("Strata_add", input$Add_row_head)]])[[2]]) )
# })

  ### Add a new row to DT
observeEvent(input$go, {
    new_row=data.frame(
      Date=as.character(input[[paste0("Date_add", input$Add_row_head)]]) ,
      Test=input[[paste0("Test_add", input$Add_row_head)]],
      Strata=input[[paste0("Strata_add", input$Add_row_head)]],
      Subject=as.character(input[[paste0("Subject_add", input$Add_row_head)]]),
      Comments=input[[paste0("Comments_add", input$Add_row_head)]]
    )
    vals_review$Data<-rbind(vals_review$Data,new_row)
    removeModal()
})




  ### save to RDS part
observeEvent(input$Updated_review,{
    saveRDS(vals_review$Data, "note1.rds")
    shinyalert(title = "Saved!", type = "success")
})


### delete selected rows part
  ### this is warning message for deleting
  observeEvent(input$Del_row_head,{
    showModal(
      if(length(input$Review_List_rows_selected)>=1 ){
        modalDialog(
        title = "Warning",
      paste("Are you sure delete",length(input$Review_List_rows_selected),"rows" ),
      footer = tagList(
        modalButton("Cancel"),
        actionButton("ok", "Yes")
      ), easyClose = TRUE)
      }else{
        modalDialog(
          title = "Warning",
        paste("Please select row(s) that you want to delete!" ),easyClose = TRUE
        )
      }
    
    )
  })
  
  ### If user say OK, then delete the selected rows
  observeEvent(input$ok, {
     vals_review$Data=vals_review$Data[-input$Review_List_rows_selected,]
     removeModal()
  })

  
    ### edit button
  observeEvent(input$mod_row_head,{
    showModal(
      if(length(input$Review_List_rows_selected)>=1 ){
        modalDialog(
          fluidPage(
            h3(strong("Modification"),align="center"),
            hr(),
            dataTableOutput('row_modif'),
            actionButton("save_changes","Save changes"),
            tags$script(HTML("$(document).on('click', '#save_changes', function () {
                             var list_value=[]
                             for (i = 0; i < $( '.new_input' ).length; i++)
                             {
                             list_value.push($( '.new_input' )[i].value)
                             }
                             Shiny.onInputChange('newValue', list_value) });")) ), size="l" )
      }else{
        modalDialog(
          title = "Warning",
          paste("Please select the row that you want to edit!" ),easyClose = TRUE
        )
      }
      
    )
  })
  
note <- data.frame()
    

  #### modify part
  output$row_modif<-renderDataTable({
    selected_row=input$Review_List_rows_selected
    old_row=vals_review$Data[selected_row,]
    row_change=list()
    for (i in colnames(old_row))
    {
      if (is.numeric(vals_review$Data[[i]]))
      {
        row_change[[i]]<-paste0('<input class="new_input" value= ','"',old_row[[i]],'"','  type="number" id=new_',i,' ><br>')
      } 
      else if( is.Date(vals_review$Data[[i]])){
        row_change[[i]]<-paste0('<input class="new_input" value= ','"',old_row[[i]],'"',' type="date" id=new_  ',i,'  ><br>') 
      }
      else 
        row_change[[i]]<-paste0('<input class="new_input" value= ','"',old_row[[i]],'"',' type="textarea"  id=new_',i,'><br>')
    }
    row_change=as.data.table(row_change)
    setnames(row_change,colnames(old_row))
    DT=row_change
    DT 
    },escape=F,options=list(dom='t',ordering=F,scrollX = TRUE),selection="none" )
  
  

  ### This is to replace the modified row to existing row
  observeEvent(input$newValue,
               {
                 newValue=lapply(input$newValue, function(col) {
                   if (suppressWarnings(all(!is.na(as.numeric(as.character(col)))))) {
                     as.numeric(as.character(col))
                   } else {
                     col
                   }
                 })
                 DF=data.frame(lapply(newValue, function(x) t(data.frame(x))))
                 colnames(DF)=colnames(vals_review$Data)
                 vals_review$Data[input$Review_List_rows_selected,]<-DF
                 removeModal()
               }
  )
  

```

**Data Cutoff Date : 22 Nov 2022**
